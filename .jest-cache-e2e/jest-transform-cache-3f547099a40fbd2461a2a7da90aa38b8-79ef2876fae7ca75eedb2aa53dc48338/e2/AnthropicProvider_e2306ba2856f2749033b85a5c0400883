84094db45bd0357b37f76ae9a36603a4
/**
 * Anthropic Provider Implementation
 * 
 * Implements the BaseProvider interface for Anthropic's Claude API.
 * Supports Claude models with proper error handling and cost calculation.
 */

const BaseProvider = require('./BaseProvider');
const logger = require('../../utils/logger');
class AnthropicProvider extends BaseProvider {
  constructor(config = {}) {
    super(config);
    if (!config.apiKey) {
      throw new Error('Anthropic API key is required');
    }
    this.apiKey = config.apiKey;
    this.baseUrl = config.baseUrl || 'https://api.anthropic.com/v1';
    this.defaultModel = config.model || 'claude-3-sonnet-20240229';
    this.version = config.version || '2023-06-01';

    // Model pricing per 1K tokens (as of 2024)
    this.pricing = {
      'claude-3-opus-20240229': {
        input: 0.015,
        output: 0.075
      },
      'claude-3-sonnet-20240229': {
        input: 0.003,
        output: 0.015
      },
      'claude-3-haiku-20240307': {
        input: 0.00025,
        output: 0.00125
      },
      'claude-2.1': {
        input: 0.008,
        output: 0.024
      },
      'claude-2.0': {
        input: 0.008,
        output: 0.024
      }
    };
  }
  getName() {
    return 'anthropic';
  }
  getSupportedModels() {
    return Object.keys(this.pricing);
  }
  async complete(request) {
    const {
      model = this.defaultModel,
      prompt,
      options = {}
    } = request;
    if (!this.getSupportedModels().includes(model)) {
      throw new Error(`Unsupported model: ${model}`);
    }
    this.incrementRequestCount();
    const requestBody = {
      model,
      max_tokens: options.maxTokens || 1000,
      messages: [{
        role: 'user',
        content: prompt
      }],
      temperature: options.temperature || 0.7,
      top_p: options.topP || 1,
      top_k: options.topK || 40
    };
    const startTime = Date.now();
    let attempt = 0;
    while (attempt < this.config.maxRetries) {
      try {
        const response = await this.makeRequest('/messages', requestBody);
        const duration = Date.now() - startTime;
        const result = {
          content: response.content[0].text,
          model: response.model,
          usage: {
            inputTokens: response.usage.input_tokens,
            outputTokens: response.usage.output_tokens,
            totalTokens: response.usage.input_tokens + response.usage.output_tokens
          },
          cost: this.calculateCost(response.model, response.usage.input_tokens, response.usage.output_tokens),
          metadata: {
            provider: this.getName(),
            duration,
            attempt: attempt + 1,
            finishReason: response.stop_reason
          }
        };
        logger.info('Anthropic completion successful', {
          model: response.model,
          inputTokens: result.usage.inputTokens,
          outputTokens: result.usage.outputTokens,
          cost: result.cost.total,
          duration
        });
        return result;
      } catch (error) {
        attempt++;
        this.incrementErrorCount();
        logger.warn('Anthropic completion attempt failed', {
          attempt,
          error: error.message,
          model,
          maxRetries: this.config.maxRetries
        });

        // Don't retry on certain errors
        if (this.isNonRetryableError(error)) {
          throw error;
        }
        if (attempt >= this.config.maxRetries) {
          logger.error('Anthropic completion failed after all retries', {
            error: error.message,
            model,
            attempts: attempt
          });
          throw error;
        }

        // Exponential backoff
        const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }
  calculateCost(model, inputTokens, outputTokens) {
    const modelPricing = this.pricing[model];
    if (!modelPricing) {
      throw new Error(`No pricing information for model: ${model}`);
    }
    const inputCost = inputTokens / 1000 * modelPricing.input;
    const outputCost = outputTokens / 1000 * modelPricing.output;
    const total = inputCost + outputCost;
    return {
      inputCost: Number(inputCost.toFixed(6)),
      outputCost: Number(outputCost.toFixed(6)),
      total: Number(total.toFixed(6)),
      currency: 'USD'
    };
  }
  async makeRequest(endpoint, data) {
    const url = `${this.baseUrl}${endpoint}`;
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      controller.abort();
    }, this.config.timeout);
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'x-api-key': this.apiKey,
          'anthropic-version': this.version,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data),
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        const error = new Error(errorData.error?.message || `HTTP ${response.status}`);
        error.status = response.status;
        error.type = errorData.error?.type;
        throw error;
      }
      return await response.json();
    } catch (error) {
      clearTimeout(timeoutId);
      if (error.name === 'AbortError') {
        const timeoutError = new Error(`Request timeout after ${this.config.timeout}ms`);
        timeoutError.code = 'TIMEOUT';
        throw timeoutError;
      }
      throw error;
    }
  }
  isNonRetryableError(error) {
    // Don't retry on authentication, permission, or validation errors
    const nonRetryableStatuses = [400, 401, 403, 404];
    const nonRetryableTypes = ['invalid_request_error', 'authentication_error', 'permission_error'];
    return nonRetryableStatuses.includes(error.status) || nonRetryableTypes.includes(error.type);
  }
}
module.exports = AnthropicProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCYXNlUHJvdmlkZXIiLCJyZXF1aXJlIiwibG9nZ2VyIiwiQW50aHJvcGljUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsImFwaUtleSIsIkVycm9yIiwiYmFzZVVybCIsImRlZmF1bHRNb2RlbCIsIm1vZGVsIiwidmVyc2lvbiIsInByaWNpbmciLCJpbnB1dCIsIm91dHB1dCIsImdldE5hbWUiLCJnZXRTdXBwb3J0ZWRNb2RlbHMiLCJPYmplY3QiLCJrZXlzIiwiY29tcGxldGUiLCJyZXF1ZXN0IiwicHJvbXB0Iiwib3B0aW9ucyIsImluY2x1ZGVzIiwiaW5jcmVtZW50UmVxdWVzdENvdW50IiwicmVxdWVzdEJvZHkiLCJtYXhfdG9rZW5zIiwibWF4VG9rZW5zIiwibWVzc2FnZXMiLCJyb2xlIiwiY29udGVudCIsInRlbXBlcmF0dXJlIiwidG9wX3AiLCJ0b3BQIiwidG9wX2siLCJ0b3BLIiwic3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsImF0dGVtcHQiLCJtYXhSZXRyaWVzIiwicmVzcG9uc2UiLCJtYWtlUmVxdWVzdCIsImR1cmF0aW9uIiwicmVzdWx0IiwidGV4dCIsInVzYWdlIiwiaW5wdXRUb2tlbnMiLCJpbnB1dF90b2tlbnMiLCJvdXRwdXRUb2tlbnMiLCJvdXRwdXRfdG9rZW5zIiwidG90YWxUb2tlbnMiLCJjb3N0IiwiY2FsY3VsYXRlQ29zdCIsIm1ldGFkYXRhIiwicHJvdmlkZXIiLCJmaW5pc2hSZWFzb24iLCJzdG9wX3JlYXNvbiIsImluZm8iLCJ0b3RhbCIsImVycm9yIiwiaW5jcmVtZW50RXJyb3JDb3VudCIsIndhcm4iLCJtZXNzYWdlIiwiaXNOb25SZXRyeWFibGVFcnJvciIsImF0dGVtcHRzIiwiZGVsYXkiLCJNYXRoIiwibWluIiwicG93IiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRUaW1lb3V0IiwibW9kZWxQcmljaW5nIiwiaW5wdXRDb3N0Iiwib3V0cHV0Q29zdCIsIk51bWJlciIsInRvRml4ZWQiLCJjdXJyZW5jeSIsImVuZHBvaW50IiwiZGF0YSIsInVybCIsImNvbnRyb2xsZXIiLCJBYm9ydENvbnRyb2xsZXIiLCJ0aW1lb3V0SWQiLCJhYm9ydCIsInRpbWVvdXQiLCJmZXRjaCIsIm1ldGhvZCIsImhlYWRlcnMiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsInNpZ25hbCIsImNsZWFyVGltZW91dCIsIm9rIiwiZXJyb3JEYXRhIiwianNvbiIsImNhdGNoIiwic3RhdHVzIiwidHlwZSIsIm5hbWUiLCJ0aW1lb3V0RXJyb3IiLCJjb2RlIiwibm9uUmV0cnlhYmxlU3RhdHVzZXMiLCJub25SZXRyeWFibGVUeXBlcyIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJBbnRocm9waWNQcm92aWRlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFudGhyb3BpYyBQcm92aWRlciBJbXBsZW1lbnRhdGlvblxuICogXG4gKiBJbXBsZW1lbnRzIHRoZSBCYXNlUHJvdmlkZXIgaW50ZXJmYWNlIGZvciBBbnRocm9waWMncyBDbGF1ZGUgQVBJLlxuICogU3VwcG9ydHMgQ2xhdWRlIG1vZGVscyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZyBhbmQgY29zdCBjYWxjdWxhdGlvbi5cbiAqL1xuXG5jb25zdCBCYXNlUHJvdmlkZXIgPSByZXF1aXJlKCcuL0Jhc2VQcm92aWRlcicpO1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvbG9nZ2VyJyk7XG5cbmNsYXNzIEFudGhyb3BpY1Byb3ZpZGVyIGV4dGVuZHMgQmFzZVByb3ZpZGVyIHtcbiAgY29uc3RydWN0b3IoY29uZmlnID0ge30pIHtcbiAgICBzdXBlcihjb25maWcpO1xuICAgIFxuICAgIGlmICghY29uZmlnLmFwaUtleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbnRocm9waWMgQVBJIGtleSBpcyByZXF1aXJlZCcpO1xuICAgIH1cbiAgICBcbiAgICB0aGlzLmFwaUtleSA9IGNvbmZpZy5hcGlLZXk7XG4gICAgdGhpcy5iYXNlVXJsID0gY29uZmlnLmJhc2VVcmwgfHwgJ2h0dHBzOi8vYXBpLmFudGhyb3BpYy5jb20vdjEnO1xuICAgIHRoaXMuZGVmYXVsdE1vZGVsID0gY29uZmlnLm1vZGVsIHx8ICdjbGF1ZGUtMy1zb25uZXQtMjAyNDAyMjknO1xuICAgIHRoaXMudmVyc2lvbiA9IGNvbmZpZy52ZXJzaW9uIHx8ICcyMDIzLTA2LTAxJztcbiAgICBcbiAgICAvLyBNb2RlbCBwcmljaW5nIHBlciAxSyB0b2tlbnMgKGFzIG9mIDIwMjQpXG4gICAgdGhpcy5wcmljaW5nID0ge1xuICAgICAgJ2NsYXVkZS0zLW9wdXMtMjAyNDAyMjknOiB7IGlucHV0OiAwLjAxNSwgb3V0cHV0OiAwLjA3NSB9LFxuICAgICAgJ2NsYXVkZS0zLXNvbm5ldC0yMDI0MDIyOSc6IHsgaW5wdXQ6IDAuMDAzLCBvdXRwdXQ6IDAuMDE1IH0sXG4gICAgICAnY2xhdWRlLTMtaGFpa3UtMjAyNDAzMDcnOiB7IGlucHV0OiAwLjAwMDI1LCBvdXRwdXQ6IDAuMDAxMjUgfSxcbiAgICAgICdjbGF1ZGUtMi4xJzogeyBpbnB1dDogMC4wMDgsIG91dHB1dDogMC4wMjQgfSxcbiAgICAgICdjbGF1ZGUtMi4wJzogeyBpbnB1dDogMC4wMDgsIG91dHB1dDogMC4wMjQgfVxuICAgIH07XG4gIH1cblxuICBnZXROYW1lKCkge1xuICAgIHJldHVybiAnYW50aHJvcGljJztcbiAgfVxuXG4gIGdldFN1cHBvcnRlZE1vZGVscygpIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5wcmljaW5nKTtcbiAgfVxuXG4gIGFzeW5jIGNvbXBsZXRlKHJlcXVlc3QpIHtcbiAgICBjb25zdCB7IG1vZGVsID0gdGhpcy5kZWZhdWx0TW9kZWwsIHByb21wdCwgb3B0aW9ucyA9IHt9IH0gPSByZXF1ZXN0O1xuICAgIFxuICAgIGlmICghdGhpcy5nZXRTdXBwb3J0ZWRNb2RlbHMoKS5pbmNsdWRlcyhtb2RlbCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgbW9kZWw6ICR7bW9kZWx9YCk7XG4gICAgfVxuXG4gICAgdGhpcy5pbmNyZW1lbnRSZXF1ZXN0Q291bnQoKTtcbiAgICBcbiAgICBjb25zdCByZXF1ZXN0Qm9keSA9IHtcbiAgICAgIG1vZGVsLFxuICAgICAgbWF4X3Rva2Vuczogb3B0aW9ucy5tYXhUb2tlbnMgfHwgMTAwMCxcbiAgICAgIG1lc3NhZ2VzOiBbeyByb2xlOiAndXNlcicsIGNvbnRlbnQ6IHByb21wdCB9XSxcbiAgICAgIHRlbXBlcmF0dXJlOiBvcHRpb25zLnRlbXBlcmF0dXJlIHx8IDAuNyxcbiAgICAgIHRvcF9wOiBvcHRpb25zLnRvcFAgfHwgMSxcbiAgICAgIHRvcF9rOiBvcHRpb25zLnRvcEsgfHwgNDBcbiAgICB9O1xuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBsZXQgYXR0ZW1wdCA9IDA7XG4gICAgXG4gICAgd2hpbGUgKGF0dGVtcHQgPCB0aGlzLmNvbmZpZy5tYXhSZXRyaWVzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMubWFrZVJlcXVlc3QoJy9tZXNzYWdlcycsIHJlcXVlc3RCb2R5KTtcbiAgICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgIGNvbnRlbnQ6IHJlc3BvbnNlLmNvbnRlbnRbMF0udGV4dCxcbiAgICAgICAgICBtb2RlbDogcmVzcG9uc2UubW9kZWwsXG4gICAgICAgICAgdXNhZ2U6IHtcbiAgICAgICAgICAgIGlucHV0VG9rZW5zOiByZXNwb25zZS51c2FnZS5pbnB1dF90b2tlbnMsXG4gICAgICAgICAgICBvdXRwdXRUb2tlbnM6IHJlc3BvbnNlLnVzYWdlLm91dHB1dF90b2tlbnMsXG4gICAgICAgICAgICB0b3RhbFRva2VuczogcmVzcG9uc2UudXNhZ2UuaW5wdXRfdG9rZW5zICsgcmVzcG9uc2UudXNhZ2Uub3V0cHV0X3Rva2Vuc1xuICAgICAgICAgIH0sXG4gICAgICAgICAgY29zdDogdGhpcy5jYWxjdWxhdGVDb3N0KFxuICAgICAgICAgICAgcmVzcG9uc2UubW9kZWwsXG4gICAgICAgICAgICByZXNwb25zZS51c2FnZS5pbnB1dF90b2tlbnMsXG4gICAgICAgICAgICByZXNwb25zZS51c2FnZS5vdXRwdXRfdG9rZW5zXG4gICAgICAgICAgKSxcbiAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgcHJvdmlkZXI6IHRoaXMuZ2V0TmFtZSgpLFxuICAgICAgICAgICAgZHVyYXRpb24sXG4gICAgICAgICAgICBhdHRlbXB0OiBhdHRlbXB0ICsgMSxcbiAgICAgICAgICAgIGZpbmlzaFJlYXNvbjogcmVzcG9uc2Uuc3RvcF9yZWFzb25cbiAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgbG9nZ2VyLmluZm8oJ0FudGhyb3BpYyBjb21wbGV0aW9uIHN1Y2Nlc3NmdWwnLCB7XG4gICAgICAgICAgbW9kZWw6IHJlc3BvbnNlLm1vZGVsLFxuICAgICAgICAgIGlucHV0VG9rZW5zOiByZXN1bHQudXNhZ2UuaW5wdXRUb2tlbnMsXG4gICAgICAgICAgb3V0cHV0VG9rZW5zOiByZXN1bHQudXNhZ2Uub3V0cHV0VG9rZW5zLFxuICAgICAgICAgIGNvc3Q6IHJlc3VsdC5jb3N0LnRvdGFsLFxuICAgICAgICAgIGR1cmF0aW9uXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIFxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgYXR0ZW1wdCsrO1xuICAgICAgICB0aGlzLmluY3JlbWVudEVycm9yQ291bnQoKTtcbiAgICAgICAgXG4gICAgICAgIGxvZ2dlci53YXJuKCdBbnRocm9waWMgY29tcGxldGlvbiBhdHRlbXB0IGZhaWxlZCcsIHtcbiAgICAgICAgICBhdHRlbXB0LFxuICAgICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgIG1vZGVsLFxuICAgICAgICAgIG1heFJldHJpZXM6IHRoaXMuY29uZmlnLm1heFJldHJpZXNcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAvLyBEb24ndCByZXRyeSBvbiBjZXJ0YWluIGVycm9yc1xuICAgICAgICBpZiAodGhpcy5pc05vblJldHJ5YWJsZUVycm9yKGVycm9yKSkge1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoYXR0ZW1wdCA+PSB0aGlzLmNvbmZpZy5tYXhSZXRyaWVzKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKCdBbnRocm9waWMgY29tcGxldGlvbiBmYWlsZWQgYWZ0ZXIgYWxsIHJldHJpZXMnLCB7XG4gICAgICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgIG1vZGVsLFxuICAgICAgICAgICAgYXR0ZW1wdHM6IGF0dGVtcHRcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gRXhwb25lbnRpYWwgYmFja29mZlxuICAgICAgICBjb25zdCBkZWxheSA9IE1hdGgubWluKDEwMDAgKiBNYXRoLnBvdygyLCBhdHRlbXB0IC0gMSksIDEwMDAwKTtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIGRlbGF5KSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY2FsY3VsYXRlQ29zdChtb2RlbCwgaW5wdXRUb2tlbnMsIG91dHB1dFRva2Vucykge1xuICAgIGNvbnN0IG1vZGVsUHJpY2luZyA9IHRoaXMucHJpY2luZ1ttb2RlbF07XG4gICAgaWYgKCFtb2RlbFByaWNpbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gcHJpY2luZyBpbmZvcm1hdGlvbiBmb3IgbW9kZWw6ICR7bW9kZWx9YCk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IGlucHV0Q29zdCA9IChpbnB1dFRva2VucyAvIDEwMDApICogbW9kZWxQcmljaW5nLmlucHV0O1xuICAgIGNvbnN0IG91dHB1dENvc3QgPSAob3V0cHV0VG9rZW5zIC8gMTAwMCkgKiBtb2RlbFByaWNpbmcub3V0cHV0O1xuICAgIGNvbnN0IHRvdGFsID0gaW5wdXRDb3N0ICsgb3V0cHV0Q29zdDtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgaW5wdXRDb3N0OiBOdW1iZXIoaW5wdXRDb3N0LnRvRml4ZWQoNikpLFxuICAgICAgb3V0cHV0Q29zdDogTnVtYmVyKG91dHB1dENvc3QudG9GaXhlZCg2KSksXG4gICAgICB0b3RhbDogTnVtYmVyKHRvdGFsLnRvRml4ZWQoNikpLFxuICAgICAgY3VycmVuY3k6ICdVU0QnXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIG1ha2VSZXF1ZXN0KGVuZHBvaW50LCBkYXRhKSB7XG4gICAgY29uc3QgdXJsID0gYCR7dGhpcy5iYXNlVXJsfSR7ZW5kcG9pbnR9YDtcbiAgICBcbiAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xuICAgIGNvbnN0IHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgY29udHJvbGxlci5hYm9ydCgpO1xuICAgIH0sIHRoaXMuY29uZmlnLnRpbWVvdXQpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ3gtYXBpLWtleSc6IHRoaXMuYXBpS2V5LFxuICAgICAgICAgICdhbnRocm9waWMtdmVyc2lvbic6IHRoaXMudmVyc2lvbixcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGRhdGEpLFxuICAgICAgICBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsXG4gICAgICB9KTtcblxuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG4gICAgICBcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgY29uc3QgZXJyb3JEYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpLmNhdGNoKCgpID0+ICh7fSkpO1xuICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihlcnJvckRhdGEuZXJyb3I/Lm1lc3NhZ2UgfHwgYEhUVFAgJHtyZXNwb25zZS5zdGF0dXN9YCk7XG4gICAgICAgIGVycm9yLnN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1cztcbiAgICAgICAgZXJyb3IudHlwZSA9IGVycm9yRGF0YS5lcnJvcj8udHlwZTtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuICAgICAgXG4gICAgICBpZiAoZXJyb3IubmFtZSA9PT0gJ0Fib3J0RXJyb3InKSB7XG4gICAgICAgIGNvbnN0IHRpbWVvdXRFcnJvciA9IG5ldyBFcnJvcihgUmVxdWVzdCB0aW1lb3V0IGFmdGVyICR7dGhpcy5jb25maWcudGltZW91dH1tc2ApO1xuICAgICAgICB0aW1lb3V0RXJyb3IuY29kZSA9ICdUSU1FT1VUJztcbiAgICAgICAgdGhyb3cgdGltZW91dEVycm9yO1xuICAgICAgfVxuICAgICAgXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBpc05vblJldHJ5YWJsZUVycm9yKGVycm9yKSB7XG4gICAgLy8gRG9uJ3QgcmV0cnkgb24gYXV0aGVudGljYXRpb24sIHBlcm1pc3Npb24sIG9yIHZhbGlkYXRpb24gZXJyb3JzXG4gICAgY29uc3Qgbm9uUmV0cnlhYmxlU3RhdHVzZXMgPSBbNDAwLCA0MDEsIDQwMywgNDA0XTtcbiAgICBjb25zdCBub25SZXRyeWFibGVUeXBlcyA9IFsnaW52YWxpZF9yZXF1ZXN0X2Vycm9yJywgJ2F1dGhlbnRpY2F0aW9uX2Vycm9yJywgJ3Blcm1pc3Npb25fZXJyb3InXTtcbiAgICBcbiAgICByZXR1cm4gbm9uUmV0cnlhYmxlU3RhdHVzZXMuaW5jbHVkZXMoZXJyb3Iuc3RhdHVzKSB8fCBcbiAgICAgICAgICAgbm9uUmV0cnlhYmxlVHlwZXMuaW5jbHVkZXMoZXJyb3IudHlwZSk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBBbnRocm9waWNQcm92aWRlcjtcbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLE1BQU1BLFlBQVksR0FBR0MsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0FBQzlDLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLG9CQUFvQixDQUFDO0FBRTVDLE1BQU1FLGlCQUFpQixTQUFTSCxZQUFZLENBQUM7RUFDM0NJLFdBQVdBLENBQUNDLE1BQU0sR0FBRyxDQUFDLENBQUMsRUFBRTtJQUN2QixLQUFLLENBQUNBLE1BQU0sQ0FBQztJQUViLElBQUksQ0FBQ0EsTUFBTSxDQUFDQyxNQUFNLEVBQUU7TUFDbEIsTUFBTSxJQUFJQyxLQUFLLENBQUMsK0JBQStCLENBQUM7SUFDbEQ7SUFFQSxJQUFJLENBQUNELE1BQU0sR0FBR0QsTUFBTSxDQUFDQyxNQUFNO0lBQzNCLElBQUksQ0FBQ0UsT0FBTyxHQUFHSCxNQUFNLENBQUNHLE9BQU8sSUFBSSw4QkFBOEI7SUFDL0QsSUFBSSxDQUFDQyxZQUFZLEdBQUdKLE1BQU0sQ0FBQ0ssS0FBSyxJQUFJLDBCQUEwQjtJQUM5RCxJQUFJLENBQUNDLE9BQU8sR0FBR04sTUFBTSxDQUFDTSxPQUFPLElBQUksWUFBWTs7SUFFN0M7SUFDQSxJQUFJLENBQUNDLE9BQU8sR0FBRztNQUNiLHdCQUF3QixFQUFFO1FBQUVDLEtBQUssRUFBRSxLQUFLO1FBQUVDLE1BQU0sRUFBRTtNQUFNLENBQUM7TUFDekQsMEJBQTBC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