6d28f1c46dee19709e02cd0b46e61b6c
/**
 * OpenAI Provider Implementation
 * 
 * Implements the BaseProvider interface for OpenAI's API.
 * Supports GPT models with proper error handling and cost calculation.
 */

const BaseProvider = require('./BaseProvider');
const logger = require('../../utils/logger');
class OpenAIProvider extends BaseProvider {
  constructor(config = {}) {
    super(config);
    if (!config.apiKey) {
      throw new Error('OpenAI API key is required');
    }
    this.apiKey = config.apiKey;
    this.baseUrl = config.baseUrl || 'https://api.openai.com/v1';
    this.defaultModel = config.model || 'gpt-4-turbo';

    // Model pricing per 1K tokens (as of 2024)
    this.pricing = {
      'gpt-4-turbo': {
        input: 0.01,
        output: 0.03
      },
      'gpt-4': {
        input: 0.03,
        output: 0.06
      },
      'gpt-3.5-turbo': {
        input: 0.0015,
        output: 0.002
      },
      'gpt-3.5-turbo-16k': {
        input: 0.003,
        output: 0.004
      }
    };
  }
  getName() {
    return 'openai';
  }
  getSupportedModels() {
    return Object.keys(this.pricing);
  }
  async complete(request) {
    const {
      model = this.defaultModel,
      prompt,
      options = {}
    } = request;
    if (!this.getSupportedModels().includes(model)) {
      throw new Error(`Unsupported model: ${model}`);
    }
    this.incrementRequestCount();
    const requestBody = {
      model,
      messages: [{
        role: 'user',
        content: prompt
      }],
      max_tokens: options.maxTokens || 1000,
      temperature: options.temperature || 0.7,
      top_p: options.topP || 1,
      frequency_penalty: options.frequencyPenalty || 0,
      presence_penalty: options.presencePenalty || 0
    };
    const startTime = Date.now();
    let attempt = 0;
    while (attempt < this.config.maxRetries) {
      try {
        const response = await this.makeRequest('/chat/completions', requestBody);
        const duration = Date.now() - startTime;
        const result = {
          content: response.choices[0].message.content,
          model: response.model,
          usage: {
            inputTokens: response.usage.prompt_tokens,
            outputTokens: response.usage.completion_tokens,
            totalTokens: response.usage.total_tokens
          },
          cost: this.calculateCost(response.model, response.usage.prompt_tokens, response.usage.completion_tokens),
          metadata: {
            provider: this.getName(),
            duration,
            attempt: attempt + 1,
            finishReason: response.choices[0].finish_reason
          }
        };
        logger.info('OpenAI completion successful', {
          model: response.model,
          inputTokens: result.usage.inputTokens,
          outputTokens: result.usage.outputTokens,
          cost: result.cost.total,
          duration
        });
        return result;
      } catch (error) {
        attempt++;
        this.incrementErrorCount();
        logger.warn('OpenAI completion attempt failed', {
          attempt,
          error: error.message,
          model,
          maxRetries: this.config.maxRetries
        });

        // Don't retry on certain errors
        if (this.isNonRetryableError(error)) {
          throw error;
        }
        if (attempt >= this.config.maxRetries) {
          logger.error('OpenAI completion failed after all retries', {
            error: error.message,
            model,
            attempts: attempt
          });
          throw error;
        }

        // Exponential backoff
        const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }
  calculateCost(model, inputTokens, outputTokens) {
    const modelPricing = this.pricing[model];
    if (!modelPricing) {
      throw new Error(`No pricing information for model: ${model}`);
    }
    const inputCost = inputTokens / 1000 * modelPricing.input;
    const outputCost = outputTokens / 1000 * modelPricing.output;
    const total = inputCost + outputCost;
    return {
      inputCost: Number(inputCost.toFixed(6)),
      outputCost: Number(outputCost.toFixed(6)),
      total: Number(total.toFixed(6)),
      currency: 'USD'
    };
  }
  async makeRequest(endpoint, data) {
    const url = `${this.baseUrl}${endpoint}`;
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      controller.abort();
    }, this.config.timeout);
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data),
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        const error = new Error(errorData.error?.message || `HTTP ${response.status}`);
        error.status = response.status;
        throw error;
      }
      return await response.json();
    } catch (error) {
      clearTimeout(timeoutId);
      if (error.name === 'AbortError') {
        const timeoutError = new Error(`Request timeout after ${this.config.timeout}ms`);
        timeoutError.code = 'TIMEOUT';
        throw timeoutError;
      }
      throw error;
    }
  }
  isNonRetryableError(error) {
    // Don't retry on authentication, permission, or validation errors
    const nonRetryableStatuses = [400, 401, 403, 404];
    return nonRetryableStatuses.includes(error.status);
  }
}
module.exports = OpenAIProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCYXNlUHJvdmlkZXIiLCJyZXF1aXJlIiwibG9nZ2VyIiwiT3BlbkFJUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsImFwaUtleSIsIkVycm9yIiwiYmFzZVVybCIsImRlZmF1bHRNb2RlbCIsIm1vZGVsIiwicHJpY2luZyIsImlucHV0Iiwib3V0cHV0IiwiZ2V0TmFtZSIsImdldFN1cHBvcnRlZE1vZGVscyIsIk9iamVjdCIsImtleXMiLCJjb21wbGV0ZSIsInJlcXVlc3QiLCJwcm9tcHQiLCJvcHRpb25zIiwiaW5jbHVkZXMiLCJpbmNyZW1lbnRSZXF1ZXN0Q291bnQiLCJyZXF1ZXN0Qm9keSIsIm1lc3NhZ2VzIiwicm9sZSIsImNvbnRlbnQiLCJtYXhfdG9rZW5zIiwibWF4VG9rZW5zIiwidGVtcGVyYXR1cmUiLCJ0b3BfcCIsInRvcFAiLCJmcmVxdWVuY3lfcGVuYWx0eSIsImZyZXF1ZW5jeVBlbmFsdHkiLCJwcmVzZW5jZV9wZW5hbHR5IiwicHJlc2VuY2VQZW5hbHR5Iiwic3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsImF0dGVtcHQiLCJtYXhSZXRyaWVzIiwicmVzcG9uc2UiLCJtYWtlUmVxdWVzdCIsImR1cmF0aW9uIiwicmVzdWx0IiwiY2hvaWNlcyIsIm1lc3NhZ2UiLCJ1c2FnZSIsImlucHV0VG9rZW5zIiwicHJvbXB0X3Rva2VucyIsIm91dHB1dFRva2VucyIsImNvbXBsZXRpb25fdG9rZW5zIiwidG90YWxUb2tlbnMiLCJ0b3RhbF90b2tlbnMiLCJjb3N0IiwiY2FsY3VsYXRlQ29zdCIsIm1ldGFkYXRhIiwicHJvdmlkZXIiLCJmaW5pc2hSZWFzb24iLCJmaW5pc2hfcmVhc29uIiwiaW5mbyIsInRvdGFsIiwiZXJyb3IiLCJpbmNyZW1lbnRFcnJvckNvdW50Iiwid2FybiIsImlzTm9uUmV0cnlhYmxlRXJyb3IiLCJhdHRlbXB0cyIsImRlbGF5IiwiTWF0aCIsIm1pbiIsInBvdyIsIlByb21pc2UiLCJyZXNvbHZlIiwic2V0VGltZW91dCIsIm1vZGVsUHJpY2luZyIsImlucHV0Q29zdCIsIm91dHB1dENvc3QiLCJOdW1iZXIiLCJ0b0ZpeGVkIiwiY3VycmVuY3kiLCJlbmRwb2ludCIsImRhdGEiLCJ1cmwiLCJjb250cm9sbGVyIiwiQWJvcnRDb250cm9sbGVyIiwidGltZW91dElkIiwiYWJvcnQiLCJ0aW1lb3V0IiwiZmV0Y2giLCJtZXRob2QiLCJoZWFkZXJzIiwiYm9keSIsIkpTT04iLCJzdHJpbmdpZnkiLCJzaWduYWwiLCJjbGVhclRpbWVvdXQiLCJvayIsImVycm9yRGF0YSIsImpzb24iLCJjYXRjaCIsInN0YXR1cyIsIm5hbWUiLCJ0aW1lb3V0RXJyb3IiLCJjb2RlIiwibm9uUmV0cnlhYmxlU3RhdHVzZXMiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiT3BlbkFJUHJvdmlkZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBPcGVuQUkgUHJvdmlkZXIgSW1wbGVtZW50YXRpb25cbiAqIFxuICogSW1wbGVtZW50cyB0aGUgQmFzZVByb3ZpZGVyIGludGVyZmFjZSBmb3IgT3BlbkFJJ3MgQVBJLlxuICogU3VwcG9ydHMgR1BUIG1vZGVscyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZyBhbmQgY29zdCBjYWxjdWxhdGlvbi5cbiAqL1xuXG5jb25zdCBCYXNlUHJvdmlkZXIgPSByZXF1aXJlKCcuL0Jhc2VQcm92aWRlcicpO1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnLi4vLi4vdXRpbHMvbG9nZ2VyJyk7XG5cbmNsYXNzIE9wZW5BSVByb3ZpZGVyIGV4dGVuZHMgQmFzZVByb3ZpZGVyIHtcbiAgY29uc3RydWN0b3IoY29uZmlnID0ge30pIHtcbiAgICBzdXBlcihjb25maWcpO1xuICAgIFxuICAgIGlmICghY29uZmlnLmFwaUtleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdPcGVuQUkgQVBJIGtleSBpcyByZXF1aXJlZCcpO1xuICAgIH1cbiAgICBcbiAgICB0aGlzLmFwaUtleSA9IGNvbmZpZy5hcGlLZXk7XG4gICAgdGhpcy5iYXNlVXJsID0gY29uZmlnLmJhc2VVcmwgfHwgJ2h0dHBzOi8vYXBpLm9wZW5haS5jb20vdjEnO1xuICAgIHRoaXMuZGVmYXVsdE1vZGVsID0gY29uZmlnLm1vZGVsIHx8ICdncHQtNC10dXJibyc7XG4gICAgXG4gICAgLy8gTW9kZWwgcHJpY2luZyBwZXIgMUsgdG9rZW5zIChhcyBvZiAyMDI0KVxuICAgIHRoaXMucHJpY2luZyA9IHtcbiAgICAgICdncHQtNC10dXJibyc6IHsgaW5wdXQ6IDAuMDEsIG91dHB1dDogMC4wMyB9LFxuICAgICAgJ2dwdC00JzogeyBpbnB1dDogMC4wMywgb3V0cHV0OiAwLjA2IH0sXG4gICAgICAnZ3B0LTMuNS10dXJibyc6IHsgaW5wdXQ6IDAuMDAxNSwgb3V0cHV0OiAwLjAwMiB9LFxuICAgICAgJ2dwdC0zLjUtdHVyYm8tMTZrJzogeyBpbnB1dDogMC4wMDMsIG91dHB1dDogMC4wMDQgfVxuICAgIH07XG4gIH1cblxuICBnZXROYW1lKCkge1xuICAgIHJldHVybiAnb3BlbmFpJztcbiAgfVxuXG4gIGdldFN1cHBvcnRlZE1vZGVscygpIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5wcmljaW5nKTtcbiAgfVxuXG4gIGFzeW5jIGNvbXBsZXRlKHJlcXVlc3QpIHtcbiAgICBjb25zdCB7IG1vZGVsID0gdGhpcy5kZWZhdWx0TW9kZWwsIHByb21wdCwgb3B0aW9ucyA9IHt9IH0gPSByZXF1ZXN0O1xuICAgIFxuICAgIGlmICghdGhpcy5nZXRTdXBwb3J0ZWRNb2RlbHMoKS5pbmNsdWRlcyhtb2RlbCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgbW9kZWw6ICR7bW9kZWx9YCk7XG4gICAgfVxuXG4gICAgdGhpcy5pbmNyZW1lbnRSZXF1ZXN0Q291bnQoKTtcbiAgICBcbiAgICBjb25zdCByZXF1ZXN0Qm9keSA9IHtcbiAgICAgIG1vZGVsLFxuICAgICAgbWVzc2FnZXM6IFt7IHJvbGU6ICd1c2VyJywgY29udGVudDogcHJvbXB0IH1dLFxuICAgICAgbWF4X3Rva2Vuczogb3B0aW9ucy5tYXhUb2tlbnMgfHwgMTAwMCxcbiAgICAgIHRlbXBlcmF0dXJlOiBvcHRpb25zLnRlbXBlcmF0dXJlIHx8IDAuNyxcbiAgICAgIHRvcF9wOiBvcHRpb25zLnRvcFAgfHwgMSxcbiAgICAgIGZyZXF1ZW5jeV9wZW5hbHR5OiBvcHRpb25zLmZyZXF1ZW5jeVBlbmFsdHkgfHwgMCxcbiAgICAgIHByZXNlbmNlX3BlbmFsdHk6IG9wdGlvbnMucHJlc2VuY2VQZW5hbHR5IHx8IDBcbiAgICB9O1xuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBsZXQgYXR0ZW1wdCA9IDA7XG4gICAgXG4gICAgd2hpbGUgKGF0dGVtcHQgPCB0aGlzLmNvbmZpZy5tYXhSZXRyaWVzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMubWFrZVJlcXVlc3QoJy9jaGF0L2NvbXBsZXRpb25zJywgcmVxdWVzdEJvZHkpO1xuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICAgIFxuICAgICAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICAgICAgY29udGVudDogcmVzcG9uc2UuY2hvaWNlc1swXS5tZXNzYWdlLmNvbnRlbnQsXG4gICAgICAgICAgbW9kZWw6IHJlc3BvbnNlLm1vZGVsLFxuICAgICAgICAgIHVzYWdlOiB7XG4gICAgICAgICAgICBpbnB1dFRva2VuczogcmVzcG9uc2UudXNhZ2UucHJvbXB0X3Rva2VucyxcbiAgICAgICAgICAgIG91dHB1dFRva2VuczogcmVzcG9uc2UudXNhZ2UuY29tcGxldGlvbl90b2tlbnMsXG4gICAgICAgICAgICB0b3RhbFRva2VuczogcmVzcG9uc2UudXNhZ2UudG90YWxfdG9rZW5zXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjb3N0OiB0aGlzLmNhbGN1bGF0ZUNvc3QoXG4gICAgICAgICAgICByZXNwb25zZS5tb2RlbCxcbiAgICAgICAgICAgIHJlc3BvbnNlLnVzYWdlLnByb21wdF90b2tlbnMsXG4gICAgICAgICAgICByZXNwb25zZS51c2FnZS5jb21wbGV0aW9uX3Rva2Vuc1xuICAgICAgICAgICksXG4gICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgIHByb3ZpZGVyOiB0aGlzLmdldE5hbWUoKSxcbiAgICAgICAgICAgIGR1cmF0aW9uLFxuICAgICAgICAgICAgYXR0ZW1wdDogYXR0ZW1wdCArIDEsXG4gICAgICAgICAgICBmaW5pc2hSZWFzb246IHJlc3BvbnNlLmNob2ljZXNbMF0uZmluaXNoX3JlYXNvblxuICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBsb2dnZXIuaW5mbygnT3BlbkFJIGNvbXBsZXRpb24gc3VjY2Vzc2Z1bCcsIHtcbiAgICAgICAgICBtb2RlbDogcmVzcG9uc2UubW9kZWwsXG4gICAgICAgICAgaW5wdXRUb2tlbnM6IHJlc3VsdC51c2FnZS5pbnB1dFRva2VucyxcbiAgICAgICAgICBvdXRwdXRUb2tlbnM6IHJlc3VsdC51c2FnZS5vdXRwdXRUb2tlbnMsXG4gICAgICAgICAgY29zdDogcmVzdWx0LmNvc3QudG90YWwsXG4gICAgICAgICAgZHVyYXRpb25cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBhdHRlbXB0Kys7XG4gICAgICAgIHRoaXMuaW5jcmVtZW50RXJyb3JDb3VudCgpO1xuICAgICAgICBcbiAgICAgICAgbG9nZ2VyLndhcm4oJ09wZW5BSSBjb21wbGV0aW9uIGF0dGVtcHQgZmFpbGVkJywge1xuICAgICAgICAgIGF0dGVtcHQsXG4gICAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgbWF4UmV0cmllczogdGhpcy5jb25maWcubWF4UmV0cmllc1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIC8vIERvbid0IHJldHJ5IG9uIGNlcnRhaW4gZXJyb3JzXG4gICAgICAgIGlmICh0aGlzLmlzTm9uUmV0cnlhYmxlRXJyb3IoZXJyb3IpKSB7XG4gICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmIChhdHRlbXB0ID49IHRoaXMuY29uZmlnLm1heFJldHJpZXMpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ09wZW5BSSBjb21wbGV0aW9uIGZhaWxlZCBhZnRlciBhbGwgcmV0cmllcycsIHtcbiAgICAgICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgICBhdHRlbXB0czogYXR0ZW1wdFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBFeHBvbmVudGlhbCBiYWNrb2ZmXG4gICAgICAgIGNvbnN0IGRlbGF5ID0gTWF0aC5taW4oMTAwMCAqIE1hdGgucG93KDIsIGF0dGVtcHQgLSAxKSwgMTAwMDApO1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgZGVsYXkpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjYWxjdWxhdGVDb3N0KG1vZGVsLCBpbnB1dFRva2Vucywgb3V0cHV0VG9rZW5zKSB7XG4gICAgY29uc3QgbW9kZWxQcmljaW5nID0gdGhpcy5wcmljaW5nW21vZGVsXTtcbiAgICBpZiAoIW1vZGVsUHJpY2luZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBwcmljaW5nIGluZm9ybWF0aW9uIGZvciBtb2RlbDogJHttb2RlbH1gKTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgaW5wdXRDb3N0ID0gKGlucHV0VG9rZW5zIC8gMTAwMCkgKiBtb2RlbFByaWNpbmcuaW5wdXQ7XG4gICAgY29uc3Qgb3V0cHV0Q29zdCA9IChvdXRwdXRUb2tlbnMgLyAxMDAwKSAqIG1vZGVsUHJpY2luZy5vdXRwdXQ7XG4gICAgY29uc3QgdG90YWwgPSBpbnB1dENvc3QgKyBvdXRwdXRDb3N0O1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBpbnB1dENvc3Q6IE51bWJlcihpbnB1dENvc3QudG9GaXhlZCg2KSksXG4gICAgICBvdXRwdXRDb3N0OiBOdW1iZXIob3V0cHV0Q29zdC50b0ZpeGVkKDYpKSxcbiAgICAgIHRvdGFsOiBOdW1iZXIodG90YWwudG9GaXhlZCg2KSksXG4gICAgICBjdXJyZW5jeTogJ1VTRCdcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgbWFrZVJlcXVlc3QoZW5kcG9pbnQsIGRhdGEpIHtcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmJhc2VVcmx9JHtlbmRwb2ludH1gO1xuICAgIFxuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgY29uc3QgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBjb250cm9sbGVyLmFib3J0KCk7XG4gICAgfSwgdGhpcy5jb25maWcudGltZW91dCk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHt0aGlzLmFwaUtleX1gLFxuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZGF0YSksXG4gICAgICAgIHNpZ25hbDogY29udHJvbGxlci5zaWduYWxcbiAgICAgIH0pO1xuXG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcbiAgICAgIFxuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICBjb25zdCBlcnJvckRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCkuY2F0Y2goKCkgPT4gKHt9KSk7XG4gICAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKGVycm9yRGF0YS5lcnJvcj8ubWVzc2FnZSB8fCBgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgICAgZXJyb3Iuc3RhdHVzID0gcmVzcG9uc2Uuc3RhdHVzO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG4gICAgICBcbiAgICAgIGlmIChlcnJvci5uYW1lID09PSAnQWJvcnRFcnJvcicpIHtcbiAgICAgICAgY29uc3QgdGltZW91dEVycm9yID0gbmV3IEVycm9yKGBSZXF1ZXN0IHRpbWVvdXQgYWZ0ZXIgJHt0aGlzLmNvbmZpZy50aW1lb3V0fW1zYCk7XG4gICAgICAgIHRpbWVvdXRFcnJvci5jb2RlID0gJ1RJTUVPVVQnO1xuICAgICAgICB0aHJvdyB0aW1lb3V0RXJyb3I7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGlzTm9uUmV0cnlhYmxlRXJyb3IoZXJyb3IpIHtcbiAgICAvLyBEb24ndCByZXRyeSBvbiBhdXRoZW50aWNhdGlvbiwgcGVybWlzc2lvbiwgb3IgdmFsaWRhdGlvbiBlcnJvcnNcbiAgICBjb25zdCBub25SZXRyeWFibGVTdGF0dXNlcyA9IFs0MDAsIDQwMSwgNDAzLCA0MDRdO1xuICAgIHJldHVybiBub25SZXRyeWFibGVTdGF0dXNlcy5pbmNsdWRlcyhlcnJvci5zdGF0dXMpO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gT3BlbkFJUHJvdmlkZXI7XG4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7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