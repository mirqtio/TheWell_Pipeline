6f7ad38d953b84e136f6c09e77ac98c3
const {
  Pool
} = require('pg');
const fs = require('fs').promises;
const path = require('path');
const logger = require('../utils/logger');

/**
 * DatabaseManager - Handles database connections, migrations, and operations
 */
class DatabaseManager {
  constructor(config = {}) {
    this.config = {
      host: config.host || process.env.DB_HOST || 'localhost',
      port: parseInt(config.port || process.env.DB_PORT || 5432),
      database: config.database || process.env.DB_NAME || 'thewell_pipeline',
      user: config.user || process.env.DB_USER || 'postgres',
      password: config.password || process.env.DB_PASSWORD || '',
      max: config.max || 20,
      idleTimeoutMillis: config.idleTimeoutMillis || 30000,
      connectionTimeoutMillis: config.connectionTimeoutMillis || 2000,
      ...config
    };
    this.pool = null;
    this.isConnected = false;
  }

  /**
     * Initialize database connection
     */
  async initialize() {
    try {
      this.pool = new Pool(this.config);

      // Test connection
      const client = await this.pool.connect();
      await client.query('SELECT NOW()');
      client.release();
      this.isConnected = true;
      logger.info('Database connection established successfully', {
        host: this.config.host,
        port: this.config.port,
        database: this.config.database
      });
      return this;
    } catch (error) {
      logger.error('Failed to initialize database connection', {
        error: error.message
      });
      throw error;
    }
  }

  /**
     * Execute a query with parameters
     */
  async query(text, params = []) {
    if (!this.isConnected) {
      throw new Error('Database not connected. Call initialize() first.');
    }
    const start = Date.now();
    try {
      const result = await this.pool.query(text, params);
      const duration = Date.now() - start;
      logger.debug('Database query executed', {
        query: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
        duration,
        rows: result.rowCount
      });
      return result;
    } catch (error) {
      const duration = Date.now() - start;
      logger.error('Database query failed', {
        query: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
        duration,
        error: error.message
      });
      throw error;
    }
  }

  /**
     * Execute a transaction
     */
  async transaction(callback) {
    const client = await this.pool.connect();
    try {
      await client.query('BEGIN');
      const result = await callback(client);
      await client.query('COMMIT');
      return result;
    } catch (error) {
      await client.query('ROLLBACK');
      throw error;
    } finally {
      client.release();
    }
  }

  /**
     * Apply database schema
     */
  async applySchema() {
    try {
      const schemaPath = path.join(__dirname, 'schema.sql');
      const schemaSQL = await fs.readFile(schemaPath, 'utf8');
      logger.info('Applying database schema...');
      await this.query(schemaSQL);
      logger.info('Database schema applied successfully');
      return true;
    } catch (error) {
      // Ignore "already exists" errors for idempotent schema application
      if (error.message.includes('already exists')) {
        logger.info('Database schema already exists, skipping application');
        return true;
      }
      logger.error('Failed to apply database schema', {
        error: error.message
      });
      throw error;
    }
  }

  /**
     * Run database migrations
     */
  async runMigrations() {
    try {
      // Create migrations table if it doesn't exist
      await this.query(`
                CREATE TABLE IF NOT EXISTS schema_migrations (
                    id SERIAL PRIMARY KEY,
                    filename VARCHAR(255) NOT NULL UNIQUE,
                    applied_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                )
            `);
      const migrationsDir = path.join(__dirname, 'migrations');
      try {
        const files = await fs.readdir(migrationsDir);
        const migrationFiles = files.filter(file => file.endsWith('.sql')).sort();
        for (const file of migrationFiles) {
          const {
            rows
          } = await this.query('SELECT id FROM schema_migrations WHERE filename = $1', [file]);
          if (rows.length === 0) {
            logger.info(`Running migration: ${file}`);
            const migrationPath = path.join(migrationsDir, file);
            const migrationSQL = await fs.readFile(migrationPath, 'utf8');
            await this.transaction(async client => {
              await client.query(migrationSQL);
              await client.query('INSERT INTO schema_migrations (filename) VALUES ($1)', [file]);
            });
            logger.info(`Migration completed: ${file}`);
          }
        }
        logger.info('All migrations completed successfully');
      } catch (dirError) {
        if (dirError.code === 'ENOENT') {
          logger.info('No migrations directory found, skipping migrations');
        } else {
          throw dirError;
        }
      }
      return true;
    } catch (error) {
      logger.error('Failed to run migrations', {
        error: error.message
      });
      throw error;
    }
  }

  /**
     * Check database health
     */
  async healthCheck() {
    try {
      const result = await this.query('SELECT NOW() as current_time, version() as version');
      return {
        status: 'healthy',
        timestamp: result.rows[0].current_time,
        version: result.rows[0].version,
        connected: this.isConnected
      };
    } catch (error) {
      return {
        status: 'unhealthy',
        error: error.message,
        connected: false
      };
    }
  }

  /**
     * Get database statistics
     */
  async getStats() {
    try {
      const tables = ['sources', 'documents', 'jobs', 'document_visibility', 'review_sessions', 'document_reviews', 'document_enrichments'];
      const stats = {};
      for (const table of tables) {
        const result = await this.query(`SELECT COUNT(*) as count FROM ${table}`);
        stats[table] = parseInt(result.rows[0].count);
      }

      // Get active jobs
      const activeJobsResult = await this.query('SELECT COUNT(*) as count FROM jobs WHERE status IN (\'pending\', \'running\')');
      stats.active_jobs = parseInt(activeJobsResult.rows[0].count);

      // Get recent documents (last 24 hours)
      const recentDocsResult = await this.query('SELECT COUNT(*) as count FROM documents WHERE created_at > NOW() - INTERVAL \'24 hours\'');
      stats.recent_documents = parseInt(recentDocsResult.rows[0].count);
      return stats;
    } catch (error) {
      logger.error('Failed to get database stats', {
        error: error.message
      });
      throw error;
    }
  }

  /**
     * Clean up old data
     */
  async cleanup(options = {}) {
    const {
      jobLogRetentionDays = 30,
      completedJobRetentionDays = 7,
      auditLogRetentionDays = 90
    } = options;
    try {
      const cleanupQueries = [
      // Clean old job logs
      {
        query: 'DELETE FROM job_logs WHERE created_at < NOW() - INTERVAL $1',
        params: [`${jobLogRetentionDays} days`],
        description: 'job logs'
      },
      // Clean completed jobs
      {
        query: 'DELETE FROM jobs WHERE status = \'completed\' AND completed_at < NOW() - INTERVAL $1',
        params: [`${completedJobRetentionDays} days`],
        description: 'completed jobs'
      },
      // Clean old audit logs
      {
        query: 'DELETE FROM visibility_audit_log WHERE created_at < NOW() - INTERVAL $1',
        params: [`${auditLogRetentionDays} days`],
        description: 'audit logs'
      }];
      const results = {};
      for (const {
        query,
        params,
        description
      } of cleanupQueries) {
        const result = await this.query(query, params);
        results[description] = result.rowCount;
        logger.info(`Cleaned up ${result.rowCount} old ${description}`);
      }
      return results;
    } catch (error) {
      logger.error('Failed to cleanup database', {
        error: error.message
      });
      throw error;
    }
  }

  /**
     * Close database connection
     */
  async close() {
    if (this.pool) {
      await this.pool.end();
      this.isConnected = false;
      logger.info('Database connection closed');
    }
  }

  /**
     * Get a client for manual transaction management
     */
  async getClient() {
    return await this.pool.connect();
  }
}
module.exports = DatabaseManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQb29sIiwicmVxdWlyZSIsImZzIiwicHJvbWlzZXMiLCJwYXRoIiwibG9nZ2VyIiwiRGF0YWJhc2VNYW5hZ2VyIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJob3N0IiwicHJvY2VzcyIsImVudiIsIkRCX0hPU1QiLCJwb3J0IiwicGFyc2VJbnQiLCJEQl9QT1JUIiwiZGF0YWJhc2UiLCJEQl9OQU1FIiwidXNlciIsIkRCX1VTRVIiLCJwYXNzd29yZCIsIkRCX1BBU1NXT1JEIiwibWF4IiwiaWRsZVRpbWVvdXRNaWxsaXMiLCJjb25uZWN0aW9uVGltZW91dE1pbGxpcyIsInBvb2wiLCJpc0Nvbm5lY3RlZCIsImluaXRpYWxpemUiLCJjbGllbnQiLCJjb25uZWN0IiwicXVlcnkiLCJyZWxlYXNlIiwiaW5mbyIsImVycm9yIiwibWVzc2FnZSIsInRleHQiLCJwYXJhbXMiLCJFcnJvciIsInN0YXJ0IiwiRGF0ZSIsIm5vdyIsInJlc3VsdCIsImR1cmF0aW9uIiwiZGVidWciLCJzdWJzdHJpbmciLCJsZW5ndGgiLCJyb3dzIiwicm93Q291bnQiLCJ0cmFuc2FjdGlvbiIsImNhbGxiYWNrIiwiYXBwbHlTY2hlbWEiLCJzY2hlbWFQYXRoIiwiam9pbiIsIl9fZGlybmFtZSIsInNjaGVtYVNRTCIsInJlYWRGaWxlIiwiaW5jbHVkZXMiLCJydW5NaWdyYXRpb25zIiwibWlncmF0aW9uc0RpciIsImZpbGVzIiwicmVhZGRpciIsIm1pZ3JhdGlvbkZpbGVzIiwiZmlsdGVyIiwiZmlsZSIsImVuZHNXaXRoIiwic29ydCIsIm1pZ3JhdGlvblBhdGgiLCJtaWdyYXRpb25TUUwiLCJkaXJFcnJvciIsImNvZGUiLCJoZWFsdGhDaGVjayIsInN0YXR1cyIsInRpbWVzdGFtcCIsImN1cnJlbnRfdGltZSIsInZlcnNpb24iLCJjb25uZWN0ZWQiLCJnZXRTdGF0cyIsInRhYmxlcyIsInN0YXRzIiwidGFibGUiLCJjb3VudCIsImFjdGl2ZUpvYnNSZXN1bHQiLCJhY3RpdmVfam9icyIsInJlY2VudERvY3NSZXN1bHQiLCJyZWNlbnRfZG9jdW1lbnRzIiwiY2xlYW51cCIsIm9wdGlvbnMiLCJqb2JMb2dSZXRlbnRpb25EYXlzIiwiY29tcGxldGVkSm9iUmV0ZW50aW9uRGF5cyIsImF1ZGl0TG9nUmV0ZW50aW9uRGF5cyIsImNsZWFudXBRdWVyaWVzIiwiZGVzY3JpcHRpb24iLCJyZXN1bHRzIiwiY2xvc2UiLCJlbmQiLCJnZXRDbGllbnQiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiRGF0YWJhc2VNYW5hZ2VyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgUG9vbCB9ID0gcmVxdWlyZSgncGcnKTtcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKS5wcm9taXNlcztcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCcuLi91dGlscy9sb2dnZXInKTtcblxuLyoqXG4gKiBEYXRhYmFzZU1hbmFnZXIgLSBIYW5kbGVzIGRhdGFiYXNlIGNvbm5lY3Rpb25zLCBtaWdyYXRpb25zLCBhbmQgb3BlcmF0aW9uc1xuICovXG5jbGFzcyBEYXRhYmFzZU1hbmFnZXIge1xuICBjb25zdHJ1Y3Rvcihjb25maWcgPSB7fSkge1xuICAgIHRoaXMuY29uZmlnID0ge1xuICAgICAgaG9zdDogY29uZmlnLmhvc3QgfHwgcHJvY2Vzcy5lbnYuREJfSE9TVCB8fCAnbG9jYWxob3N0JyxcbiAgICAgIHBvcnQ6IHBhcnNlSW50KGNvbmZpZy5wb3J0IHx8IHByb2Nlc3MuZW52LkRCX1BPUlQgfHwgNTQzMiksXG4gICAgICBkYXRhYmFzZTogY29uZmlnLmRhdGFiYXNlIHx8IHByb2Nlc3MuZW52LkRCX05BTUUgfHwgJ3RoZXdlbGxfcGlwZWxpbmUnLFxuICAgICAgdXNlcjogY29uZmlnLnVzZXIgfHwgcHJvY2Vzcy5lbnYuREJfVVNFUiB8fCAncG9zdGdyZXMnLFxuICAgICAgcGFzc3dvcmQ6IGNvbmZpZy5wYXNzd29yZCB8fCBwcm9jZXNzLmVudi5EQl9QQVNTV09SRCB8fCAnJyxcbiAgICAgIG1heDogY29uZmlnLm1heCB8fCAyMCxcbiAgICAgIGlkbGVUaW1lb3V0TWlsbGlzOiBjb25maWcuaWRsZVRpbWVvdXRNaWxsaXMgfHwgMzAwMDAsXG4gICAgICBjb25uZWN0aW9uVGltZW91dE1pbGxpczogY29uZmlnLmNvbm5lY3Rpb25UaW1lb3V0TWlsbGlzIHx8IDIwMDAsXG4gICAgICAuLi5jb25maWdcbiAgICB9O1xuICAgICAgICBcbiAgICB0aGlzLnBvb2wgPSBudWxsO1xuICAgIHRoaXMuaXNDb25uZWN0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgICAqIEluaXRpYWxpemUgZGF0YWJhc2UgY29ubmVjdGlvblxuICAgICAqL1xuICBhc3luYyBpbml0aWFsaXplKCkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnBvb2wgPSBuZXcgUG9vbCh0aGlzLmNvbmZpZyk7XG4gICAgICAgICAgICBcbiAgICAgIC8vIFRlc3QgY29ubmVjdGlvblxuICAgICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5wb29sLmNvbm5lY3QoKTtcbiAgICAgIGF3YWl0IGNsaWVudC5xdWVyeSgnU0VMRUNUIE5PVygpJyk7XG4gICAgICBjbGllbnQucmVsZWFzZSgpO1xuICAgICAgICAgICAgXG4gICAgICB0aGlzLmlzQ29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgIGxvZ2dlci5pbmZvKCdEYXRhYmFzZSBjb25uZWN0aW9uIGVzdGFibGlzaGVkIHN1Y2Nlc3NmdWxseScsIHtcbiAgICAgICAgaG9zdDogdGhpcy5jb25maWcuaG9zdCxcbiAgICAgICAgcG9ydDogdGhpcy5jb25maWcucG9ydCxcbiAgICAgICAgZGF0YWJhc2U6IHRoaXMuY29uZmlnLmRhdGFiYXNlXG4gICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGluaXRpYWxpemUgZGF0YWJhc2UgY29ubmVjdGlvbicsIHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICAgKiBFeGVjdXRlIGEgcXVlcnkgd2l0aCBwYXJhbWV0ZXJzXG4gICAgICovXG4gIGFzeW5jIHF1ZXJ5KHRleHQsIHBhcmFtcyA9IFtdKSB7XG4gICAgaWYgKCF0aGlzLmlzQ29ubmVjdGVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGFiYXNlIG5vdCBjb25uZWN0ZWQuIENhbGwgaW5pdGlhbGl6ZSgpIGZpcnN0LicpO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wb29sLnF1ZXJ5KHRleHQsIHBhcmFtcyk7XG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydDtcbiAgICAgICAgICAgIFxuICAgICAgbG9nZ2VyLmRlYnVnKCdEYXRhYmFzZSBxdWVyeSBleGVjdXRlZCcsIHtcbiAgICAgICAgcXVlcnk6IHRleHQuc3Vic3RyaW5nKDAsIDEwMCkgKyAodGV4dC5sZW5ndGggPiAxMDAgPyAnLi4uJyA6ICcnKSxcbiAgICAgICAgZHVyYXRpb24sXG4gICAgICAgIHJvd3M6IHJlc3VsdC5yb3dDb3VudFxuICAgICAgfSk7XG4gICAgICAgICAgICBcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0O1xuICAgICAgbG9nZ2VyLmVycm9yKCdEYXRhYmFzZSBxdWVyeSBmYWlsZWQnLCB7XG4gICAgICAgIHF1ZXJ5OiB0ZXh0LnN1YnN0cmluZygwLCAxMDApICsgKHRleHQubGVuZ3RoID4gMTAwID8gJy4uLicgOiAnJyksXG4gICAgICAgIGR1cmF0aW9uLFxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZVxuICAgICAgfSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICAgKiBFeGVjdXRlIGEgdHJhbnNhY3Rpb25cbiAgICAgKi9cbiAgYXN5bmMgdHJhbnNhY3Rpb24oY2FsbGJhY2spIHtcbiAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLnBvb2wuY29ubmVjdCgpO1xuICAgICAgICBcbiAgICB0cnkge1xuICAgICAgYXdhaXQgY2xpZW50LnF1ZXJ5KCdCRUdJTicpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY2FsbGJhY2soY2xpZW50KTtcbiAgICAgIGF3YWl0IGNsaWVudC5xdWVyeSgnQ09NTUlUJyk7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBhd2FpdCBjbGllbnQucXVlcnkoJ1JPTExCQUNLJyk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgY2xpZW50LnJlbGVhc2UoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICAgKiBBcHBseSBkYXRhYmFzZSBzY2hlbWFcbiAgICAgKi9cbiAgYXN5bmMgYXBwbHlTY2hlbWEoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjaGVtYVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnc2NoZW1hLnNxbCcpO1xuICAgICAgY29uc3Qgc2NoZW1hU1FMID0gYXdhaXQgZnMucmVhZEZpbGUoc2NoZW1hUGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgICAgIFxuICAgICAgbG9nZ2VyLmluZm8oJ0FwcGx5aW5nIGRhdGFiYXNlIHNjaGVtYS4uLicpO1xuICAgICAgYXdhaXQgdGhpcy5xdWVyeShzY2hlbWFTUUwpO1xuICAgICAgbG9nZ2VyLmluZm8oJ0RhdGFiYXNlIHNjaGVtYSBhcHBsaWVkIHN1Y2Nlc3NmdWxseScpO1xuICAgICAgICAgICAgXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gSWdub3JlIFwiYWxyZWFkeSBleGlzdHNcIiBlcnJvcnMgZm9yIGlkZW1wb3RlbnQgc2NoZW1hIGFwcGxpY2F0aW9uXG4gICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnYWxyZWFkeSBleGlzdHMnKSkge1xuICAgICAgICBsb2dnZXIuaW5mbygnRGF0YWJhc2Ugc2NoZW1hIGFscmVhZHkgZXhpc3RzLCBza2lwcGluZyBhcHBsaWNhdGlvbicpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGFwcGx5IGRhdGFiYXNlIHNjaGVtYScsIHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICAgKiBSdW4gZGF0YWJhc2UgbWlncmF0aW9uc1xuICAgICAqL1xuICBhc3luYyBydW5NaWdyYXRpb25zKCkge1xuICAgIHRyeSB7XG4gICAgICAvLyBDcmVhdGUgbWlncmF0aW9ucyB0YWJsZSBpZiBpdCBkb2Vzbid0IGV4aXN0XG4gICAgICBhd2FpdCB0aGlzLnF1ZXJ5KGBcbiAgICAgICAgICAgICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBzY2hlbWFfbWlncmF0aW9ucyAoXG4gICAgICAgICAgICAgICAgICAgIGlkIFNFUklBTCBQUklNQVJZIEtFWSxcbiAgICAgICAgICAgICAgICAgICAgZmlsZW5hbWUgVkFSQ0hBUigyNTUpIE5PVCBOVUxMIFVOSVFVRSxcbiAgICAgICAgICAgICAgICAgICAgYXBwbGllZF9hdCBUSU1FU1RBTVAgV0lUSCBUSU1FIFpPTkUgREVGQVVMVCBOT1coKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIGApO1xuXG4gICAgICBjb25zdCBtaWdyYXRpb25zRGlyID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ21pZ3JhdGlvbnMnKTtcbiAgICAgICAgICAgIFxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZmlsZXMgPSBhd2FpdCBmcy5yZWFkZGlyKG1pZ3JhdGlvbnNEaXIpO1xuICAgICAgICBjb25zdCBtaWdyYXRpb25GaWxlcyA9IGZpbGVzXG4gICAgICAgICAgLmZpbHRlcihmaWxlID0+IGZpbGUuZW5kc1dpdGgoJy5zcWwnKSlcbiAgICAgICAgICAuc29ydCgpO1xuXG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBtaWdyYXRpb25GaWxlcykge1xuICAgICAgICAgIGNvbnN0IHsgcm93cyB9ID0gYXdhaXQgdGhpcy5xdWVyeShcbiAgICAgICAgICAgICdTRUxFQ1QgaWQgRlJPTSBzY2hlbWFfbWlncmF0aW9ucyBXSEVSRSBmaWxlbmFtZSA9ICQxJyxcbiAgICAgICAgICAgIFtmaWxlXVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBpZiAocm93cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGBSdW5uaW5nIG1pZ3JhdGlvbjogJHtmaWxlfWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBtaWdyYXRpb25QYXRoID0gcGF0aC5qb2luKG1pZ3JhdGlvbnNEaXIsIGZpbGUpO1xuICAgICAgICAgICAgY29uc3QgbWlncmF0aW9uU1FMID0gYXdhaXQgZnMucmVhZEZpbGUobWlncmF0aW9uUGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgdGhpcy50cmFuc2FjdGlvbihhc3luYyAoY2xpZW50KSA9PiB7XG4gICAgICAgICAgICAgIGF3YWl0IGNsaWVudC5xdWVyeShtaWdyYXRpb25TUUwpO1xuICAgICAgICAgICAgICBhd2FpdCBjbGllbnQucXVlcnkoXG4gICAgICAgICAgICAgICAgJ0lOU0VSVCBJTlRPIHNjaGVtYV9taWdyYXRpb25zIChmaWxlbmFtZSkgVkFMVUVTICgkMSknLFxuICAgICAgICAgICAgICAgIFtmaWxlXVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGBNaWdyYXRpb24gY29tcGxldGVkOiAke2ZpbGV9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgIGxvZ2dlci5pbmZvKCdBbGwgbWlncmF0aW9ucyBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgICB9IGNhdGNoIChkaXJFcnJvcikge1xuICAgICAgICBpZiAoZGlyRXJyb3IuY29kZSA9PT0gJ0VOT0VOVCcpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbygnTm8gbWlncmF0aW9ucyBkaXJlY3RvcnkgZm91bmQsIHNraXBwaW5nIG1pZ3JhdGlvbnMnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBkaXJFcnJvcjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcnVuIG1pZ3JhdGlvbnMnLCB7IGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAgICogQ2hlY2sgZGF0YWJhc2UgaGVhbHRoXG4gICAgICovXG4gIGFzeW5jIGhlYWx0aENoZWNrKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnF1ZXJ5KCdTRUxFQ1QgTk9XKCkgYXMgY3VycmVudF90aW1lLCB2ZXJzaW9uKCkgYXMgdmVyc2lvbicpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzOiAnaGVhbHRoeScsXG4gICAgICAgIHRpbWVzdGFtcDogcmVzdWx0LnJvd3NbMF0uY3VycmVudF90aW1lLFxuICAgICAgICB2ZXJzaW9uOiByZXN1bHQucm93c1swXS52ZXJzaW9uLFxuICAgICAgICBjb25uZWN0ZWQ6IHRoaXMuaXNDb25uZWN0ZWRcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1czogJ3VuaGVhbHRoeScsXG4gICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICBjb25uZWN0ZWQ6IGZhbHNlXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgICAqIEdldCBkYXRhYmFzZSBzdGF0aXN0aWNzXG4gICAgICovXG4gIGFzeW5jIGdldFN0YXRzKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB0YWJsZXMgPSBbXG4gICAgICAgICdzb3VyY2VzJywgJ2RvY3VtZW50cycsICdqb2JzJywgJ2RvY3VtZW50X3Zpc2liaWxpdHknLFxuICAgICAgICAncmV2aWV3X3Nlc3Npb25zJywgJ2RvY3VtZW50X3Jldmlld3MnLCAnZG9jdW1lbnRfZW5yaWNobWVudHMnXG4gICAgICBdO1xuICAgICAgICAgICAgXG4gICAgICBjb25zdCBzdGF0cyA9IHt9O1xuICAgICAgICAgICAgXG4gICAgICBmb3IgKGNvbnN0IHRhYmxlIG9mIHRhYmxlcykge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnF1ZXJ5KGBTRUxFQ1QgQ09VTlQoKikgYXMgY291bnQgRlJPTSAke3RhYmxlfWApO1xuICAgICAgICBzdGF0c1t0YWJsZV0gPSBwYXJzZUludChyZXN1bHQucm93c1swXS5jb3VudCk7XG4gICAgICB9XG4gICAgICAgICAgICBcbiAgICAgIC8vIEdldCBhY3RpdmUgam9ic1xuICAgICAgY29uc3QgYWN0aXZlSm9ic1Jlc3VsdCA9IGF3YWl0IHRoaXMucXVlcnkoXG4gICAgICAgICdTRUxFQ1QgQ09VTlQoKikgYXMgY291bnQgRlJPTSBqb2JzIFdIRVJFIHN0YXR1cyBJTiAoXFwncGVuZGluZ1xcJywgXFwncnVubmluZ1xcJyknXG4gICAgICApO1xuICAgICAgc3RhdHMuYWN0aXZlX2pvYnMgPSBwYXJzZUludChhY3RpdmVKb2JzUmVzdWx0LnJvd3NbMF0uY291bnQpO1xuICAgICAgICAgICAgXG4gICAgICAvLyBHZXQgcmVjZW50IGRvY3VtZW50cyAobGFzdCAyNCBob3VycylcbiAgICAgIGNvbnN0IHJlY2VudERvY3NSZXN1bHQgPSBhd2FpdCB0aGlzLnF1ZXJ5KFxuICAgICAgICAnU0VMRUNUIENPVU5UKCopIGFzIGNvdW50IEZST00gZG9jdW1lbnRzIFdIRVJFIGNyZWF0ZWRfYXQgPiBOT1coKSAtIElOVEVSVkFMIFxcJzI0IGhvdXJzXFwnJ1xuICAgICAgKTtcbiAgICAgIHN0YXRzLnJlY2VudF9kb2N1bWVudHMgPSBwYXJzZUludChyZWNlbnREb2NzUmVzdWx0LnJvd3NbMF0uY291bnQpO1xuICAgICAgICAgICAgXG4gICAgICByZXR1cm4gc3RhdHM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIGdldCBkYXRhYmFzZSBzdGF0cycsIHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICAgKiBDbGVhbiB1cCBvbGQgZGF0YVxuICAgICAqL1xuICBhc3luYyBjbGVhbnVwKG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHtcbiAgICAgIGpvYkxvZ1JldGVudGlvbkRheXMgPSAzMCxcbiAgICAgIGNvbXBsZXRlZEpvYlJldGVudGlvbkRheXMgPSA3LFxuICAgICAgYXVkaXRMb2dSZXRlbnRpb25EYXlzID0gOTBcbiAgICB9ID0gb3B0aW9ucztcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBjbGVhbnVwUXVlcmllcyA9IFtcbiAgICAgICAgLy8gQ2xlYW4gb2xkIGpvYiBsb2dzXG4gICAgICAgIHtcbiAgICAgICAgICBxdWVyeTogJ0RFTEVURSBGUk9NIGpvYl9sb2dzIFdIRVJFIGNyZWF0ZWRfYXQgPCBOT1coKSAtIElOVEVSVkFMICQxJyxcbiAgICAgICAgICBwYXJhbXM6IFtgJHtqb2JMb2dSZXRlbnRpb25EYXlzfSBkYXlzYF0sXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdqb2IgbG9ncydcbiAgICAgICAgfSxcbiAgICAgICAgLy8gQ2xlYW4gY29tcGxldGVkIGpvYnNcbiAgICAgICAge1xuICAgICAgICAgIHF1ZXJ5OiAnREVMRVRFIEZST00gam9icyBXSEVSRSBzdGF0dXMgPSBcXCdjb21wbGV0ZWRcXCcgQU5EIGNvbXBsZXRlZF9hdCA8IE5PVygpIC0gSU5URVJWQUwgJDEnLFxuICAgICAgICAgIHBhcmFtczogW2Ake2NvbXBsZXRlZEpvYlJldGVudGlvbkRheXN9IGRheXNgXSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ2NvbXBsZXRlZCBqb2JzJ1xuICAgICAgICB9LFxuICAgICAgICAvLyBDbGVhbiBvbGQgYXVkaXQgbG9nc1xuICAgICAgICB7XG4gICAgICAgICAgcXVlcnk6ICdERUxFVEUgRlJPTSB2aXNpYmlsaXR5X2F1ZGl0X2xvZyBXSEVSRSBjcmVhdGVkX2F0IDwgTk9XKCkgLSBJTlRFUlZBTCAkMScsXG4gICAgICAgICAgcGFyYW1zOiBbYCR7YXVkaXRMb2dSZXRlbnRpb25EYXlzfSBkYXlzYF0sXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdhdWRpdCBsb2dzJ1xuICAgICAgICB9XG4gICAgICBdO1xuXG4gICAgICBjb25zdCByZXN1bHRzID0ge307XG4gICAgICAgICAgICBcbiAgICAgIGZvciAoY29uc3QgeyBxdWVyeSwgcGFyYW1zLCBkZXNjcmlwdGlvbiB9IG9mIGNsZWFudXBRdWVyaWVzKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucXVlcnkocXVlcnksIHBhcmFtcyk7XG4gICAgICAgIHJlc3VsdHNbZGVzY3JpcHRpb25dID0gcmVzdWx0LnJvd0NvdW50O1xuICAgICAgICBsb2dnZXIuaW5mbyhgQ2xlYW5lZCB1cCAke3Jlc3VsdC5yb3dDb3VudH0gb2xkICR7ZGVzY3JpcHRpb259YCk7XG4gICAgICB9XG4gICAgICAgICAgICBcbiAgICAgIHJldHVybiByZXN1bHRzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBjbGVhbnVwIGRhdGFiYXNlJywgeyBlcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgICAqIENsb3NlIGRhdGFiYXNlIGNvbm5lY3Rpb25cbiAgICAgKi9cbiAgYXN5bmMgY2xvc2UoKSB7XG4gICAgaWYgKHRoaXMucG9vbCkge1xuICAgICAgYXdhaXQgdGhpcy5wb29sLmVuZCgpO1xuICAgICAgdGhpcy5pc0Nvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgbG9nZ2VyLmluZm8oJ0RhdGFiYXNlIGNvbm5lY3Rpb24gY2xvc2VkJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAgICogR2V0IGEgY2xpZW50IGZvciBtYW51YWwgdHJhbnNhY3Rpb24gbWFuYWdlbWVudFxuICAgICAqL1xuICBhc3luYyBnZXRDbGllbnQoKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucG9vbC5jb25uZWN0KCk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBEYXRhYmFzZU1hbmFnZXI7XG4iXSwibWFwcGluZ3MiOiJBQUFBLE1BQU07RUFBRUE7QUFBSyxDQUFDLEdBQUdDLE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDOUIsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUNFLFFBQVE7QUFDakMsTUFBTUMsSUFBSSxHQUFHSCxPQUFPLENBQUMsTUFBTSxDQUFDO0FBQzVCLE1BQU1JLE1BQU0sR0FBR0osT0FBTyxDQUFDLGlCQUFpQixDQUFDOztBQUV6QztBQUNBO0FBQ0E7QUFDQSxNQUFNSyxlQUFlLENBQUM7RUFDcEJDLFdBQVdBLENBQUNDLE1BQU0sR0FBRyxDQUFDLENBQUMsRUFBRTtJQUN2QixJQUFJLENBQUNBLE1BQU0sR0FBRztNQUNaQyxJQUFJLEVBQUVELE1BQU0sQ0FBQ0MsSUFBSSxJQUFJQyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsT0FBTyxJQUFJLFdBQVc7TUFDdkRDLElBQUksRUFBRUMsUUFBUSxDQUFDTixNQUFNLENBQUNLLElBQUksSUFBSUgsT0FBTyxDQUFDQyxHQUFHLENBQUNJLE9BQU8sSUFBSSxJQUFJLENBQUM7TUFDMURDLFFBQVEsRUFBRVIsTUFBTSxDQUFDUSxRQUFRLElBQUlOLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDTSxPQUFPLElBQUksa0JBQWtCO01BQ3RFQyxJQUFJLEVBQUVWLE1BQU0sQ0FBQ1UsSUFBSSxJQUFJUixPQUFPLENBQUNDLEdBQUcsQ0FBQ1EsT0FBTyxJQUFJLFVBQVU7TUFDdERDLFFBQVEsRUFBRVosTUFBTSxDQUFDWSxRQUFRLElBQUlWLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDVSxXQUFXLElBQUksRUFBRTtNQUMxREMsR0FBRyxFQUFFZCxNQUFNLENBQUNjLEdBQUcsSUFBSSxFQUFFO01BQ3JCQyxpQkFBaUIsRUFBRWYsTUFBTSxDQUFDZSxpQkFBaUIsSUFBSSxLQUFLO01BQ3BEQyx1QkFBdUIsRUFBRWhCLE1BQU0sQ0FBQ2dCLHVCQUF1QixJQUFJLElBQUk7TUFDL0QsR0FBR2hCO0lBQ0wsQ0FBQztJQUVELElBQUksQ0FBQ2lCLElBQUksR0FBRyxJQUFJO0lBQ2hCLElBQUksQ0FBQ0MsV0FBVyxHQUFHLEtBQUs7RUFDMUI7O0VBRUE7QUFDRjtBQUNBO0VBQ0UsTUFBTUMsVUFBVUEsQ0FBQSxFQUFHO0lBQ2pCLElBQUk7TUFDRixJQUFJLENBQUNGLElBQUksR0FBRyxJQUFJekIsSUFBSSxDQUFDLElBQUksQ0FBQ1EsTUFBTSxDQUFDOztNQUVqQztNQUNBLE1BQU1vQixNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUNILElBQUksQ0FBQ0ksT0FBTyxDQUFDLENBQUM7TUFDeEMsTUFBTUQsTUFBTSxDQUFDRSxLQUFLLENBQUMsY0FBYyxDQUFDO01BQ2xDRixNQUFNLENBQUNHLE9BQU8sQ0FBQyxDQUFDO01BRWhCLElBQUksQ0FBQ0wsV0FBVyxHQUFHLElBQUk7TUFDdkJyQixNQUFNLENBQUMyQixJQUFJLENBQUMsOENBQThDLEVBQUU7UUFDMUR2QixJQUFJLEVBQUUsSUFBSSxDQUFDRCxNQUFNLENBQUNDLElBQUk7UUFDdEJJLElBQUksRUFBRSxJQUFJLENBQUNMLE1BQU0sQ0FBQ0ssSUFBSTtRQUN0QkcsUUFBUSxFQUFFLElBQUksQ0FBQ1IsTUFBTSxDQUFDUTtNQUN4QixDQUFDLENBQUM7TUFFRixPQUFPLElBQUk7SUFDYixDQUFDLENBQUMsT0FBT2lCLEtBQUssRUFBRTtNQUNkNUIsTUFBTSxDQUFDNEIsS0FBSyxDQUFDLDBDQUEwQyxFQUFFO1FBQUVBLEtBQUssRUFBRUEsS0FBSyxDQUFDQztNQUFRLENBQUMsQ0FBQztNQUNsRixNQUFNRCxLQUFLO0lBQ2I7RUFDRjs7RUFFQTtBQUNGO0FBQ0E7RUFDRSxNQUFNSCxLQUFLQSxDQUFDSyxJQUFJLEVBQUVDLE1BQU0sR0FBRyxFQUFFLEVBQUU7SUFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQ1YsV0FBVyxFQUFFO01BQ3JCLE1BQU0sSUFBSVcsS0FBSyxDQUFDLGtEQUFrRCxDQUFDO0lBQ3JFO0lBRUEsTUFBTUMsS0FBSyxHQUFHQyxJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hCLElBQUk7TUFDRixNQUFNQyxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUNoQixJQUFJLENBQUNLLEtBQUssQ0FBQ0ssSUFBSSxFQUFFQyxNQUFNLENBQUM7TUFDbEQsTUFBTU0sUUFBUSxHQUFHSCxJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDLEdBQUdGLEtBQUs7TUFFbkNqQyxNQUFNLENBQUNzQyxLQUFLLENBQUMseUJBQXlCLEVBQUU7UUFDdENiLEtBQUssRUFBRUssSUFBSSxDQUFDUyxTQUFTLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxJQUFJVCxJQUFJLENBQUNVLE1BQU0sR0FBRyxHQUFHLEdBQUcsS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNoRUgsUUFBUTtRQUNSSSxJQUFJLEVBQUVMLE1BQU0sQ0FBQ007TUFDZixDQUFDLENBQUM7TUFFRixPQUFPTixNQUFNO0lBQ2YsQ0FBQyxDQUFDLE9BQU9SLEtBQUssRUFBRTtNQUNkLE1BQU1TLFFBQVEsR0FBR0gsSUFBSSxDQUFDQyxHQUFHLENBQUMsQ0FBQyxHQUFHRixLQUFLO01BQ25DakMsTUFBTSxDQUFDNEIsS0FBSyxDQUFDLHVCQUF1QixFQUFFO1FBQ3BDSCxLQUFLLEVBQUVLLElBQUksQ0FBQ1MsU0FBUyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsSUFBSVQsSUFBSSxDQUFDVSxNQUFNLEdBQUcsR0FBRyxHQUFHLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDaEVILFFBQVE7UUFDUlQsS0FBSyxFQUFFQSxLQUFLLENBQUNDO01BQ2YsQ0FBQyxDQUFDO01BQ0YsTUFBTUQsS0FBSztJQUNiO0VBQ0Y7O0VBRUE7QUFDRjtBQUNBO0VBQ0UsTUFBTWUsV0FBV0EsQ0FBQ0MsUUFBUSxFQUFFO0lBQzFCLE1BQU1yQixNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUNILElBQUksQ0FBQ0ksT0FBTyxDQUFDLENBQUM7SUFFeEMsSUFBSTtNQUNGLE1BQU1ELE1BQU0sQ0FBQ0UsS0FBSyxDQUFDLE9BQU8sQ0FBQztNQUMzQixNQUFNVyxNQUFNLEdBQUcsTUFBTVEsUUFBUSxDQUFDckIsTUFBTSxDQUFDO01BQ3JDLE1BQU1BLE1BQU0sQ0FBQ0UsS0FBSyxDQUFDLFFBQVEsQ0FBQztNQUM1QixPQUFPVyxNQUFNO0lBQ2YsQ0FBQyxDQUFDLE9BQU9SLEtBQUssRUFBRTtNQUNkLE1BQU1MLE1BQU0sQ0FBQ0UsS0FBSyxDQUFDLFVBQVUsQ0FBQztNQUM5QixNQUFNRyxLQUFLO0lBQ2IsQ0FBQyxTQUFTO01BQ1JMLE1BQU0sQ0FBQ0csT0FBTyxDQUFDLENBQUM7SUFDbEI7RUFDRjs7RUFFQTtBQUNGO0FBQ0E7RUFDRSxNQUFNbUIsV0FBV0EsQ0FBQSxFQUFHO0lBQ2xCLElBQUk7TUFDRixNQUFNQyxVQUFVLEdBQUcvQyxJQUFJLENBQUNnRCxJQUFJLENBQUNDLFNBQVMsRUFBRSxZQUFZLENBQUM7TUFDckQsTUFBTUMsU0FBUyxHQUFHLE1BQU1wRCxFQUFFLENBQUNxRCxRQUFRLENBQUNKLFVBQVUsRUFBRSxNQUFNLENBQUM7TUFFdkQ5QyxNQUFNLENBQUMyQixJQUFJLENBQUMsNkJBQTZCLENBQUM7TUFDMUMsTUFBTSxJQUFJLENBQUNGLEtBQUssQ0FBQ3dCLFNBQVMsQ0FBQztNQUMzQmpELE1BQU0sQ0FBQzJCLElBQUksQ0FBQyxzQ0FBc0MsQ0FBQztNQUVuRCxPQUFPLElBQUk7SUFDYixDQUFDLENBQUMsT0FBT0MsS0FBSyxFQUFFO01BQ2Q7TUFDQSxJQUFJQSxLQUFLLENBQUNDLE9BQU8sQ0FBQ3NCLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO1FBQzVDbkQsTUFBTSxDQUFDMkIsSUFBSSxDQUFDLHNEQUFzRCxDQUFDO1FBQ25FLE9BQU8sSUFBSTtNQUNiO01BQ0EzQixNQUFNLENBQUM0QixLQUFLLENBQUMsaUNBQWlDLEVBQUU7UUFBRUEsS0FBSyxFQUFFQSxLQUFLLENBQUNDO01BQVEsQ0FBQyxDQUFDO01BQ3pFLE1BQU1ELEtBQUs7SUFDYjtFQUNGOztFQUVBO0FBQ0Y7QUFDQTtFQUNFLE1BQU13QixhQUFhQSxDQUFBLEVBQUc7SUFDcEIsSUFBSTtNQUNGO01BQ0EsTUFBTSxJQUFJLENBQUMzQixLQUFLLENBQUM7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWEsQ0FBQztNQUVSLE1BQU00QixhQUFhLEdBQUd0RCxJQUFJLENBQUNnRCxJQUFJLENBQUNDLFNBQVMsRUFBRSxZQUFZLENBQUM7TUFFeEQsSUFBSTtRQUNGLE1BQU1NLEtBQUssR0FBRyxNQUFNekQsRUFBRSxDQUFDMEQsT0FBTyxDQUFDRixhQUFhLENBQUM7UUFDN0MsTUFBTUcsY0FBYyxHQUFHRixLQUFLLENBQ3pCRyxNQUFNLENBQUNDLElBQUksSUFBSUEsSUFBSSxDQUFDQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FDckNDLElBQUksQ0FBQyxDQUFDO1FBRVQsS0FBSyxNQUFNRixJQUFJLElBQUlGLGNBQWMsRUFBRTtVQUNqQyxNQUFNO1lBQUVmO1VBQUssQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDaEIsS0FBSyxDQUMvQixzREFBc0QsRUFDdEQsQ0FBQ2lDLElBQUksQ0FDUCxDQUFDO1VBRUQsSUFBSWpCLElBQUksQ0FBQ0QsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNyQnhDLE1BQU0sQ0FBQzJCLElBQUksQ0FBQyxzQkFBc0IrQixJQUFJLEVBQUUsQ0FBQztZQUV6QyxNQUFNRyxhQUFhLEdBQUc5RCxJQUFJLENBQUNnRCxJQUFJLENBQUNNLGFBQWEsRUFBRUssSUFBSSxDQUFDO1lBQ3BELE1BQU1JLFlBQVksR0FBRyxNQUFNakUsRUFBRSxDQUFDcUQsUUFBUSxDQUFDVyxhQUFhLEVBQUUsTUFBTSxDQUFDO1lBRTdELE1BQU0sSUFBSSxDQUFDbEIsV0FBVyxDQUFDLE1BQU9wQixNQUFNLElBQUs7Y0FDdkMsTUFBTUEsTUFBTSxDQUFDRSxLQUFLLENBQUNxQyxZQUFZLENBQUM7Y0FDaEMsTUFBTXZDLE1BQU0sQ0FBQ0UsS0FBSyxDQUNoQixzREFBc0QsRUFDdEQsQ0FBQ2lDLElBQUksQ0FDUCxDQUFDO1lBQ0gsQ0FBQyxDQUFDO1lBRUYxRCxNQUFNLENBQUMyQixJQUFJLENBQUMsd0JBQXdCK0IsSUFBSSxFQUFFLENBQUM7VUFDN0M7UUFDRjtRQUVBMUQsTUFBTSxDQUFDMkIsSUFBSSxDQUFDLHVDQUF1QyxDQUFDO01BQ3RELENBQUMsQ0FBQyxPQUFPb0MsUUFBUSxFQUFFO1FBQ2pCLElBQUlBLFFBQVEsQ0FBQ0MsSUFBSSxLQUFLLFFBQVEsRUFBRTtVQUM5QmhFLE1BQU0sQ0FBQzJCLElBQUksQ0FBQyxvREFBb0QsQ0FBQztRQUNuRSxDQUFDLE1BQU07VUFDTCxNQUFNb0MsUUFBUTtRQUNoQjtNQUNGO01BRUEsT0FBTyxJQUFJO0lBQ2IsQ0FBQyxDQUFDLE9BQU9uQyxLQUFLLEVBQUU7TUFDZDVCLE1BQU0sQ0FBQzRCLEtBQUssQ0FBQywwQkFBMEIsRUFBRTtRQUFFQSxLQUFLLEVBQUVBLEtBQUssQ0FBQ0M7TUFBUSxDQUFDLENBQUM7TUFDbEUsTUFBTUQsS0FBSztJQUNiO0VBQ0Y7O0VBRUE7QUFDRjtBQUNBO0VBQ0UsTUFBTXFDLFdBQVdBLENBQUEsRUFBRztJQUNsQixJQUFJO01BQ0YsTUFBTTdCLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQ1gsS0FBSyxDQUFDLG9EQUFvRCxDQUFDO01BQ3JGLE9BQU87UUFDTHlDLE1BQU0sRUFBRSxTQUFTO1FBQ2pCQyxTQUFTLEVBQUUvQixNQUFNLENBQUNLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzJCLFlBQVk7UUFDdENDLE9BQU8sRUFBRWpDLE1BQU0sQ0FBQ0ssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDNEIsT0FBTztRQUMvQkMsU0FBUyxFQUFFLElBQUksQ0FBQ2pEO01BQ2xCLENBQUM7SUFDSCxDQUFDLENBQUMsT0FBT08sS0FBSyxFQUFFO01BQ2QsT0FBTztRQUNMc0MsTUFBTSxFQUFFLFdBQVc7UUFDbkJ0QyxLQUFLLEVBQUVBLEtBQUssQ0FBQ0MsT0FBTztRQUNwQnlDLFNBQVMsRUFBRTtNQUNiLENBQUM7SUFDSDtFQUNGOztFQUVBO0FBQ0Y7QUFDQTtFQUNFLE1BQU1DLFFBQVFBLENBQUEsRUFBRztJQUNmLElBQUk7TUFDRixNQUFNQyxNQUFNLEdBQUcsQ0FDYixTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxxQkFBcUIsRUFDckQsaUJBQWlCLEVBQUUsa0JBQWtCLEVBQUUsc0JBQXNCLENBQzlEO01BRUQsTUFBTUMsS0FBSyxHQUFHLENBQUMsQ0FBQztNQUVoQixLQUFLLE1BQU1DLEtBQUssSUFBSUYsTUFBTSxFQUFFO1FBQzFCLE1BQU1wQyxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUNYLEtBQUssQ0FBQyxpQ0FBaUNpRCxLQUFLLEVBQUUsQ0FBQztRQUN6RUQsS0FBSyxDQUFDQyxLQUFLLENBQUMsR0FBR2pFLFFBQVEsQ0FBQzJCLE1BQU0sQ0FBQ0ssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDa0MsS0FBSyxDQUFDO01BQy9DOztNQUVBO01BQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUNuRCxLQUFLLENBQ3ZDLCtFQUNGLENBQUM7TUFDRGdELEtBQUssQ0FBQ0ksV0FBVyxHQUFHcEUsUUFBUSxDQUFDbUUsZ0JBQWdCLENBQUNuQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUNrQyxLQUFLLENBQUM7O01BRTVEO01BQ0EsTUFBTUcsZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUNyRCxLQUFLLENBQ3ZDLDBGQUNGLENBQUM7TUFDRGdELEtBQUssQ0FBQ00sZ0JBQWdCLEdBQUd0RSxRQUFRLENBQUNxRSxnQkFBZ0IsQ0FBQ3JDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQ2tDLEtBQUssQ0FBQztNQUVqRSxPQUFPRixLQUFLO0lBQ2QsQ0FBQyxDQUFDLE9BQU83QyxLQUFLLEVBQUU7TUFDZDVCLE1BQU0sQ0FBQzRCLEtBQUssQ0FBQyw4QkFBOEIsRUFBRTtRQUFFQSxLQUFLLEVBQUVBLEtBQUssQ0FBQ0M7TUFBUSxDQUFDLENBQUM7TUFDdEUsTUFBTUQsS0FBSztJQUNiO0VBQ0Y7O0VBRUE7QUFDRjtBQUNBO0VBQ0UsTUFBTW9ELE9BQU9BLENBQUNDLE9BQU8sR0FBRyxDQUFDLENBQUMsRUFBRTtJQUMxQixNQUFNO01BQ0pDLG1CQUFtQixHQUFHLEVBQUU7TUFDeEJDLHlCQUF5QixHQUFHLENBQUM7TUFDN0JDLHFCQUFxQixHQUFHO0lBQzFCLENBQUMsR0FBR0gsT0FBTztJQUVYLElBQUk7TUFDRixNQUFNSSxjQUFjLEdBQUc7TUFDckI7TUFDQTtRQUNFNUQsS0FBSyxFQUFFLDZEQUE2RDtRQUNwRU0sTUFBTSxFQUFFLENBQUMsR0FBR21ELG1CQUFtQixPQUFPLENBQUM7UUFDdkNJLFdBQVcsRUFBRTtNQUNmLENBQUM7TUFDRDtNQUNBO1FBQ0U3RCxLQUFLLEVBQUUsc0ZBQXNGO1FBQzdGTSxNQUFNLEVBQUUsQ0FBQyxHQUFHb0QseUJBQXlCLE9BQU8sQ0FBQztRQUM3Q0csV0FBVyxFQUFFO01BQ2YsQ0FBQztNQUNEO01BQ0E7UUFDRTdELEtBQUssRUFBRSx5RUFBeUU7UUFDaEZNLE1BQU0sRUFBRSxDQUFDLEdBQUdxRCxxQkFBcUIsT0FBTyxDQUFDO1FBQ3pDRSxXQUFXLEVBQUU7TUFDZixDQUFDLENBQ0Y7TUFFRCxNQUFNQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO01BRWxCLEtBQUssTUFBTTtRQUFFOUQsS0FBSztRQUFFTSxNQUFNO1FBQUV1RDtNQUFZLENBQUMsSUFBSUQsY0FBYyxFQUFFO1FBQzNELE1BQU1qRCxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUNYLEtBQUssQ0FBQ0EsS0FBSyxFQUFFTSxNQUFNLENBQUM7UUFDOUN3RCxPQUFPLENBQUNELFdBQVcsQ0FBQyxHQUFHbEQsTUFBTSxDQUFDTSxRQUFRO1FBQ3RDMUMsTUFBTSxDQUFDMkIsSUFBSSxDQUFDLGNBQWNTLE1BQU0sQ0FBQ00sUUFBUSxRQUFRNEMsV0FBVyxFQUFFLENBQUM7TUFDakU7TUFFQSxPQUFPQyxPQUFPO0lBQ2hCLENBQUMsQ0FBQyxPQUFPM0QsS0FBSyxFQUFFO01BQ2Q1QixNQUFNLENBQUM0QixLQUFLLENBQUMsNEJBQTRCLEVBQUU7UUFBRUEsS0FBSyxFQUFFQSxLQUFLLENBQUNDO01BQVEsQ0FBQyxDQUFDO01BQ3BFLE1BQU1ELEtBQUs7SUFDYjtFQUNGOztFQUVBO0FBQ0Y7QUFDQTtFQUNFLE1BQU00RCxLQUFLQSxDQUFBLEVBQUc7SUFDWixJQUFJLElBQUksQ0FBQ3BFLElBQUksRUFBRTtNQUNiLE1BQU0sSUFBSSxDQUFDQSxJQUFJLENBQUNxRSxHQUFHLENBQUMsQ0FBQztNQUNyQixJQUFJLENBQUNwRSxXQUFXLEdBQUcsS0FBSztNQUN4QnJCLE1BQU0sQ0FBQzJCLElBQUksQ0FBQyw0QkFBNEIsQ0FBQztJQUMzQztFQUNGOztFQUVBO0FBQ0Y7QUFDQTtFQUNFLE1BQU0rRCxTQUFTQSxDQUFBLEVBQUc7SUFDaEIsT0FBTyxNQUFNLElBQUksQ0FBQ3RFLElBQUksQ0FBQ0ksT0FBTyxDQUFDLENBQUM7RUFDbEM7QUFDRjtBQUVBbUUsTUFBTSxDQUFDQyxPQUFPLEdBQUczRixlQUFlIiwiaWdub3JlTGlzdCI6W119